<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SketchWave – Sdílené plátno</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body class="d-flex flex-column">
  <!-- Top navbar -->
  <nav class="navbar navbar-light border-bottom" style="background: var(--sw-surface); border-color: var(--sw-border) !important; transition: background-color 0.3s ease;">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <button id="sidebarToggle" class="btn btn-outline-secondary btn-sm sidebar-toggle-btn" type="button" aria-label="Otevřít panel">
          <i class="bi bi-list"></i>
        </button>
        <a class="navbar-brand" href="/">
          <img src="/img/sw1.png" alt="SketchWave" class="logo-light" height="40">
          <img src="/img/sw2.png" alt="SketchWave" class="logo-dark" height="40">
        </a>
      </div>
      <div class="d-flex align-items-center gap-2">
        <% if (typeof user !== 'undefined' && user) { %>
          <button id="notificationBtn" class="notification-toggle" title="Oznámení">
            <i class="bi bi-bell"></i>
            <span id="notificationBadge" class="notification-badge d-none">0</span>
          </button>
        <% } %>
        <button id="themeToggle" class="theme-toggle" title="Přepnout režim">
          <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
        <% if (typeof user !== 'undefined' && user) { %>
          <span class="me-2"><%= user.name %></span>
          <a href="/profile" class="btn btn-outline-secondary btn-sm">Profil</a>
        <% } else { %>
          <a href="/login" class="btn btn-outline-secondary btn-sm">Přihlásit se</a>
        <% } %>
      </div>
    </div>
  </nav>

  <!-- App layout -->
  <div id="app" class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <aside class="sw-sidebar border-end">
        <div class="sw-sidebar-inner d-flex flex-column py-3">
          <button id="sidebarClose" class="btn btn-outline-secondary btn-sm sidebar-close d-lg-none align-self-end" type="button">Zavřít</button>
          <!-- Sekce správa tabule -->
          <div class="sidebar-section border-bottom pb-3 mb-3">
            <% if (typeof user !== 'undefined' && user) { %>
              <label for="boardNameInput" class="form-label board-label small">Uložit</label>
              <input type="text" id="boardNameInput" class="board-name-input form-control form-control-sm mb-2" placeholder="Název tabule" maxlength="128">
              <div class="d-flex flex-column gap-2">
                <button id="saveBoardBtn" class="btn btn-board-primary w-100">Uložit tabuli</button>
                <button id="openBoardBtn" class="btn btn-board-secondary w-100">Otevřít tabuli</button>
              </div>
            <% } %>
            <button id="newBoardBtn" class="btn btn-board-secondary w-100 mt-2">Nová tabule</button>
          </div>
          <div class="sidebar-top w-100">
           <!-- Sekce nástrojů -->
           <div class="sidebar-section">
             <button class="btn btn-tool mb-2" id="showDrawMenu">Kreslení</button>
             <div class="tool-menu d-none" id="drawMenu">
               <label class="form-label">Barva</label>
               <input id="colorInput" type="color" class="form-control form-control-color mb-2" value="#22223b" title="Vyberte barvu">
               <label class="form-label">Tloušťka</label>
               <input id="widthRange" type="range" class="form-range mb-2" min="1" max="30" value="4">
               <!-- ovládací tlačítka pro undo/redo/clear/save byla přemístěna do spodní části sidebaru -->
             </div>
             <button class="btn btn-tool mb-2" id="showTextMenu">Text</button>
             <div class="tool-menu d-none" id="textMenu">
               <label class="form-label">Barva textu</label>
               <input id="textColorInput" type="color" class="form-control form-control-color mb-2" value="#22223b" title="Barva textu">
               <label class="form-label">Velikost písma (stupeň)</label>
               <input id="textWidthRange" type="range" class="form-range mb-2" min="1" max="40" value="4">
               <p class="text-muted small">Dvojklikem na plátno vložíte text. Potvrďte Enter.</p>
             </div>
             <button class="btn btn-tool mb-2" id="showShapeMenu">Tvary</button>
             <div class="tool-menu d-none" id="shapeMenu">
               <label class="form-label">Barva tvaru</label>
               <input id="shapeColorInput" type="color" class="form-control form-control-color mb-2" value="#22223b" title="Barva tvaru">
               <label class="form-label">Tloušťka čáry</label>
               <input id="shapeWidthRange" type="range" class="form-range mb-2" min="1" max="30" value="4">
               <div class="btn-group-vertical" role="group" aria-label="Tvary">
                 <input type="radio" id="shape-rect" name="shapeType" value="rect" checked hidden>
                 <label class="btn btn-outline-dark" for="shape-rect">Obdélník</label>
                 <input type="radio" id="shape-circle" name="shapeType" value="circle" hidden>
                 <label class="btn btn-outline-dark" for="shape-circle">Kruh</label>
                 <input type="radio" id="shape-line" name="shapeType" value="line" hidden>
                 <label class="btn btn-outline-dark" for="shape-line">Čára</label>
               </div>
               <p class="text-muted small mt-2">Tažením nakreslíte tvar.</p>
             </div>
           </div>

           <!-- Sekce plátna -->
           <div class="sidebar-section sidebar-section-canvas">
             <button class="btn btn-tool btn-tool-canvas mb-2" id="showCanvasMenu">Plátno</button>
             <div class="tool-menu d-none" id="canvasMenu">
             <label class="form-label">Velikost plátna (px)</label>
             <div class="d-flex gap-2 mb-2">
               <input id="canvasWidthInput" type="number" class="form-control" min="300" max="4000" value="1280" placeholder="Šířka">
               <input id="canvasHeightInput" type="number" class="form-control" min="300" max="4000" value="720" placeholder="Výška">
             </div>
             <div class="d-flex flex-wrap gap-2 mb-2">
               <button type="button" class="btn btn-outline-secondary btn-sm preset-size" data-w="1280" data-h="720">1280×720</button>
               <button type="button" class="btn btn-outline-secondary btn-sm preset-size" data-w="1600" data-h="900">1600×900</button>
               <button type="button" class="btn btn-outline-secondary btn-sm preset-size" data-w="1920" data-h="1080">1920×1080</button>
               <button type="button" class="btn btn-outline-secondary btn-sm preset-size" data-w="1024" data-h="768">1024×768</button>
             </div>
             <button id="applyCanvasSize" class="btn btn-outline-secondary btn-sm mb-3" type="button">Změnit velikost</button>
             <label class="form-label">Zoom</label>
             <div class="d-flex align-items-center gap-2 mb-2">
               <button id="zoomOutBtn" type="button" class="btn btn-outline-secondary btn-sm" title="Zoom -">-</button>
               <input id="zoomRange" type="range" class="form-range" min="10" max="300" value="100">
               <button id="zoomInBtn" type="button" class="btn btn-outline-secondary btn-sm" title="Zoom +">+</button>
             </div>
             <div class="d-flex justify-content-between align-items-center">
               <span id="zoomLabel" class="small text-muted">100%</span>
               <div class="btn-group">
                 <button id="fitZoomBtn" type="button" class="btn btn-outline-secondary btn-sm" title="Přizpůsobit oknu">Fit</button>
                 <button id="resetZoomBtn" type="button" class="btn btn-outline-secondary btn-sm" title="100%">Reset</button>
               </div>
             </div>
             <div class="mt-3">
               <button id="centerToggleBtn" type="button" class="btn btn-outline-secondary btn-sm w-100" title="Přepnout centrování">Přepnout centrování</button>
             </div>
           </div>
          </div>

          <div class="sidebar-bottom w-100">
           <div class="d-flex gap-2 justify-content-center mb-2 control-row">
             <button id="undoBtn" class="btn btn-outline-secondary btn-sm" title="Zpět">
               <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i>
               <span class="visually-hidden">Zpět</span>
             </button>
             <button id="redoBtn" class="btn btn-outline-secondary btn-sm" title="Znovu">
               <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
               <span class="visually-hidden">Znovu</span>
             </button>
             <button id="clearBtn" class="btn btn-outline-secondary btn-sm" title="Vymazat">
               <i class="bi bi-trash" aria-hidden="true"></i>
               <span class="visually-hidden">Vymazat</span>
             </button>
             <button id="saveBtn" class="btn btn-outline-secondary btn-sm" title="Uložit">
               <i class="bi bi-download" aria-hidden="true"></i>
               <span class="visually-hidden">Uložit</span>
             </button>
           </div>
           <button class="btn btn-tool mb-2" id="inviteBtn">Pozvat</button>
           <button class="btn btn-tool mb-2" id="copyLinkBtn">Kopírovat odkaz</button>
          </div>
        </div>
      </aside>

      <!-- Stage / canvas -->
      <main class="col d-flex">
        <div class="canvas-wrap shadow" id="canvasScroll">
          <div class="canvas-inner" id="canvasInner">
            <canvas id="drawCanvas" style="position:absolute;left:0;top:0;z-index:1;"></canvas>
            <canvas id="overlayCanvas" style="position:absolute;left:0;top:0;z-index:2;pointer-events:none;"></canvas>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Invite Friends Overlay -->
  <div id="inviteOverlay" class="invite-overlay d-none">
    <div class="invite-modal">
      <div class="invite-header">
        <h4>Pozvat přátele</h4>
        <button id="inviteClose" class="btn-close" aria-label="Zavřít"></button>
      </div>
      <div class="invite-body">
        <div class="mb-3">
          <label class="form-label">Email</label>
          <div class="d-flex gap-2">
            <input type="email" id="inviteEmail" class="form-control" placeholder="např. petr.novak@gmail.com">
            <button id="inviteAddBtn" class="btn btn-outline-secondary">Přidat</button>
          </div>
          <small class="text-muted">Pošle žádost o přátelství na zadaný email.</small>
        </div>
        <div class="invite-list">
          <% if (typeof friends !== 'undefined' && friends && friends.length > 0) { %>
            <% friends.forEach(f => { %>
              <div class="invite-item">
                <div class="invite-name"><%= f.friend_name %></div>
                <div class="invite-email"><%= f.friend_email %></div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-success btn-sm" data-friend-id="<%= f.friend_id %>">Pozvat do tabule</button>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted">Nemáte žádné přátele k pozvání.</p>
          <% } %>
        </div>
      </div>
      <div class="invite-footer d-flex justify-content-end gap-2">
        <button id="inviteCancel" class="btn btn-outline-secondary">Zavřít</button>
      </div>
    </div>
  </div>

  <!-- Open Boards Overlay -->
  <% if (typeof user !== 'undefined' && user) { %>
  <div id="openOverlay" class="invite-overlay d-none">
    <div class="invite-modal">
      <div class="invite-header">
        <h4>Otevřít tabuli</h4>
        <button id="openClose" class="btn-close" aria-label="Zavřít"></button>
      </div>
      <div class="invite-body">
        <div id="boardsList" class="invite-list"></div>
      </div>
      <div class="invite-footer d-flex justify-content-end gap-2">
        <button id="openCancel" class="btn btn-outline-secondary">Zavřít</button>
      </div>
    </div>
  </div>
  <% } %>

  <div id="sidebarBackdrop" class="sidebar-backdrop d-none"></div>

  <!-- Notification Overlay -->
  <div id="notificationOverlay" class="notification-overlay d-none">
    <div class="notification-header">
      <h5>Oznámení</h5>
      <button id="notificationClose" class="btn-close btn-sm" aria-label="Zavřít"></button>
    </div>
    <div class="notification-body">
      <div id="notificationList"></div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Inicializace Socket.IO
    if (typeof io !== 'undefined') {
      window.SW_SOCKET = io();
    }
  </script>
  <script src="/js/sketchpad.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const INITIAL_BOARD_ID = urlParams.get('board');
    const INITIAL_SHARE_TOKEN = urlParams.get('share');
    window.SHARE_TOKEN = INITIAL_SHARE_TOKEN || null;

    const drawBtn = document.getElementById('showDrawMenu');
    const canvasBtn = document.getElementById('showCanvasMenu');
    const textBtn = document.getElementById('showTextMenu');
    const shapeBtn = document.getElementById('showShapeMenu');
    const drawMenu = document.getElementById('drawMenu');
    const canvasMenu = document.getElementById('canvasMenu');
    const textMenu = document.getElementById('textMenu');
    const shapeMenu = document.getElementById('shapeMenu');


    function toggleToolMenu(button, menu) {
      const toolMenus = [drawMenu, textMenu, shapeMenu];
      const toolButtons = [drawBtn, textBtn, shapeBtn];

      toolMenus.forEach(m => m.classList.add('d-none'));
      toolButtons.forEach(b => b.classList.remove('active'));

      menu.classList.toggle('d-none');
      button.classList.toggle('active');
    }


    function toggleCanvasMenu() {
      canvasMenu.classList.toggle('d-none');
      canvasBtn.classList.toggle('active');
    }

    drawBtn.addEventListener('click', () => toggleToolMenu(drawBtn, drawMenu));
    textBtn.addEventListener('click', () => toggleToolMenu(textBtn, textMenu));
    shapeBtn.addEventListener('click', () => toggleToolMenu(shapeBtn, shapeMenu));
    canvasBtn.addEventListener('click', toggleCanvasMenu);
    // Invite overlay
    const inviteBtn = document.getElementById('inviteBtn');
    const inviteOverlay = document.getElementById('inviteOverlay');
    const inviteClose = document.getElementById('inviteClose');
    const inviteCancel = document.getElementById('inviteCancel');
    const toggleInvite = (show) => {
      inviteOverlay.classList.toggle('d-none', !show);
      document.body.style.overflow = show ? 'hidden' : '';
    };
    inviteBtn.addEventListener('click', () => toggleInvite(true));
    inviteClose.addEventListener('click', () => toggleInvite(false));
    inviteCancel.addEventListener('click', () => toggleInvite(false));

    // Kopírování sdílecího odkazu
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyLinkBtn) {
      copyLinkBtn.addEventListener('click', async () => {
        const bid = window.boardId;
        if (!bid) { alert('Nejprve uložte nebo otevřete tabuli.'); return; }
        try {
          const resp = await fetch(`/board/${bid}/share-link`, { method: 'POST' });
          const data = await resp.json();
          if (!resp.ok || !data.url) throw new Error(data.error || 'Chyba při generování odkazu');
          await navigator.clipboard.writeText(data.url);
          alert('Odkaz zkopírován do schránky.');
        } catch (e) {
          console.error(e);
          alert('Nepodařilo se vygenerovat odkaz: ' + e.message);
        }
      });
    }

    // Open Boards overlay
    const openBtn = document.getElementById('openBoardBtn');
    const openOverlay = document.getElementById('openOverlay');
    const openClose = document.getElementById('openClose');
    const openCancel = document.getElementById('openCancel');
    const boardsList = document.getElementById('boardsList');
    const toggleOpen = (show) => {
      if (!openOverlay) return;
      openOverlay.classList.toggle('d-none', !show);
      document.body.style.overflow = show ? 'hidden' : '';
    };
      async function fetchBoards() {
        if (!boardsList) return;
        try {
          const [mineRes, sharedRes] = await Promise.all([
            fetch('/boards/my'),
            fetch('/boards/shared')
          ]);
          const mineData = await mineRes.json();
          const sharedData = await sharedRes.json();
          const mine = Array.isArray(mineData.boards) ? mineData.boards : [];
          const shared = Array.isArray(sharedData.boards) ? sharedData.boards : [];
          boardsList.innerHTML = '';

          const renderSection = (title, arr, emptyText) => {
            const section = document.createElement('div');
            section.className = 'mb-3';
            const heading = document.createElement('h6');
            heading.className = 'text-muted mb-2';
            heading.textContent = title;
            section.appendChild(heading);
            if (!arr.length) {
              const p = document.createElement('p');
              p.className = 'text-muted';
              p.textContent = emptyText;
              section.appendChild(p);
              boardsList.appendChild(section);
              return;
            }
            arr.forEach(b => {
              const row = document.createElement('div');
              row.className = 'invite-item';
              row.innerHTML = `
                <div>
                  <div class="invite-name">${b.name}</div>
                  <div class="invite-email text-muted">${b.size_x}×${b.size_y}${b.owner_name ? ' · vlastník: ' + b.owner_name : ''}${b.role ? ' · role: ' + b.role : ''}</div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" data-id="${b.id}">Otevřít</button>
                </div>`;
              section.appendChild(row);
            });
            boardsList.appendChild(section);
          };

          renderSection('Moje tabule', mine, 'Nemáte žádné uložené tabule.');
          renderSection('Sdílené tabule', shared, 'Žádné tabule se sdíleným přístupem.');

          boardsList.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', async (ev) => {
              const id = ev.currentTarget.getAttribute('data-id');
              try {
                const res = await fetch(`/board/${id}`);
                const data = await res.json();
                if (!res.ok || !data || !data.board) {
                  alert(data.error || 'Nepodařilo se načíst tabuli.');
                  return;
                }
                const event = new CustomEvent('loadBoardData', { detail: data });
                window.dispatchEvent(event);
                window.boardId = data.board.id;
                toggleOpen(false);
              } catch (e) {
                alert('Chyba při načítání tabule.');
              }
            });
          });
        } catch (e) {
          boardsList.innerHTML = '<p class="text-danger">Chyba při načítání seznamu tabulí.</p>';
        }
      }
    if (openBtn) {
      openBtn.addEventListener('click', () => { toggleOpen(true); fetchBoards(); });
      openClose && openClose.addEventListener('click', () => toggleOpen(false));
      openCancel && openCancel.addEventListener('click', () => toggleOpen(false));
    }


    const inviteAddBtn = document.getElementById('inviteAddBtn');
    const inviteEmail = document.getElementById('inviteEmail');
    if (inviteAddBtn && inviteEmail) {
      inviteAddBtn.addEventListener('click', async () => {
        const email = inviteEmail.value.trim();
        if (!email) { alert('Zadejte email.'); return; }
        try {
            const res = await fetch('/friends/invite', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (data && data.success) {
              alert('Pozvánka odeslána.');
              inviteEmail.value = '';
            } else {
              alert(data.message || 'Pozvánku se nepodařilo odeslat.');
            }
        } catch (e) {
          alert('Chyba komunikace se serverem.');
        }
      });
    }

    document.querySelectorAll('.invite-item button[data-friend-id]').forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        const friendId = ev.currentTarget.getAttribute('data-friend-id');
        const boardId = window.boardId;
        if (!boardId) { alert('Nejprve otevřete tabuli, do které chcete pozvat.'); return; }
        try {
            const res = await fetch(`/board/${boardId}/invite`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ friend_id: friendId, role: 'editor' })
            });
            const data = await res.json();
            if (data && data.success) {
              alert('Udělen přístup do tabule.');
            } else {
              alert(data.message || 'Nepodařilo se udělit přístup.');
            }
        } catch (e) {
          alert('Chyba komunikace se serverem.');
        }
      });
    });

    // Toggle centrování plátna
    const centerToggleBtn = document.getElementById('centerToggleBtn');
    const canvasWrap = document.getElementById('canvasScroll');
    centerToggleBtn.addEventListener('click', () => {
      canvasWrap.classList.toggle('canvas-centered');
      centerToggleBtn.classList.toggle('active');
      centerToggleBtn.textContent = canvasWrap.classList.contains('canvas-centered') ? 'Ukotvit vlevo' : 'Přepnout centrování';
    });

    // Theme toggle logic
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;

    // Load saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    function updateThemeIcon(theme) {
      if (theme === 'dark') {
        themeIcon.className = 'bi bi-sun-fill';
      } else {
        themeIcon.className = 'bi bi-moon-fill';
      }
    }


    // Sidebar responsive toggle (mobile overlay)
    const sidebar = document.querySelector('.sw-sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarClose = document.getElementById('sidebarClose');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');

    const isMobileSidebar = () => window.innerWidth <= 1000 || window.innerHeight < 800;

    function setSidebarOpen(open) {
      if (!sidebar) return;
      if (open && isMobileSidebar()) {
        sidebar.classList.add('is-open');
        sidebarBackdrop?.classList.remove('d-none');
        document.body.style.overflow = 'hidden';
      } else {
        sidebar.classList.remove('is-open');
        sidebarBackdrop?.classList.add('d-none');
        document.body.style.overflow = '';
      }
    }

    function syncSidebarMode() {
      if (!sidebar) return;
      if (isMobileSidebar()) {
        sidebar.classList.add('is-mobile');
        setSidebarOpen(false);
      } else {
        sidebar.classList.remove('is-mobile');
        sidebar.classList.remove('is-open');
        sidebarBackdrop?.classList.add('d-none');
        document.body.style.overflow = 'hidden';
      }
    }

    sidebarToggle?.addEventListener('click', () => setSidebarOpen(true));
    sidebarClose?.addEventListener('click', () => setSidebarOpen(false));
    sidebarBackdrop?.addEventListener('click', () => setSidebarOpen(false));
    window.addEventListener('resize', syncSidebarMode);
    syncSidebarMode();

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });
    }

    async function loadBoardByShare(boardId, shareToken) {
      try {
        const qs = shareToken ? `?share=${encodeURIComponent(shareToken)}` : '';
        const resp = await fetch(`/board/${boardId}${qs}`);
        const data = await resp.json();
        if (resp.ok && data.board && Array.isArray(data.objects)) {
          window.boardId = parseInt(boardId, 10);
          window.SHARE_TOKEN = shareToken || null;
          window.dispatchEvent(new CustomEvent('loadBoardData', { detail: data }));
        } else {
          console.warn('Nepodařilo se načíst tabuli přes sdílený odkaz', data);
        }
      } catch (e) {
        console.error('loadBoardByShare failed', e);
      }
    }

    if (INITIAL_BOARD_ID && INITIAL_SHARE_TOKEN) {
      loadBoardByShare(INITIAL_BOARD_ID, INITIAL_SHARE_TOKEN);
    }

    // Notification system
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationOverlay = document.getElementById('notificationOverlay');
    const notificationClose = document.getElementById('notificationClose');
    const notificationList = document.getElementById('notificationList');
    const notificationBadge = document.getElementById('notificationBadge');
    let notifications = [];

    function updateNotificationUI() {
      notificationBadge.textContent = notifications.length;
      if (notifications.length > 0) {
        notificationBtn.classList.add('has-new');
        notificationBadge.classList.remove('d-none');
      } else {
        notificationBtn.classList.remove('has-new');
        notificationBadge.classList.add('d-none');
      }

      notificationList.innerHTML = '';
      if (notifications.length === 0) {
        notificationList.innerHTML = '<div style="padding: 24px 16px; text-align: center; color: var(--sw-muted); font-size: 0.9rem;">Žádná nová oznámení</div>';
        return;
      }

      notifications.forEach((notif, idx) => {
        let notificationTitle = notif.boardName || 'Nová žádost';
        if (notif.type === 'friend-accepted') {
          notificationTitle = 'Nová aktivita';
        }
        const item = document.createElement('div');
        item.className = 'notification-item';
        item.innerHTML = `
          <div class="notification-item-title">${notificationTitle}</div>
          <div class="notification-item-text">${notif.message}</div>
        `;
        item.addEventListener('click', async () => {
          if (notif.type === 'friend-request') {
            notifications.splice(idx, 1);
            updateNotificationUI();
            window.location.href = '/profile';
            return;
          }

          if (notif.type === 'friend-accepted') {
            notifications.splice(idx, 1);
            updateNotificationUI();
            return;
          }

          try {
            const res = await fetch(`/board/${notif.boardId}`);
            if (!res.ok) {
              alert('Nepodařilo se načíst tabuli.');
              return;
            }
            const data = await res.json();
            const event = new CustomEvent('loadBoardData', { detail: data });
            window.dispatchEvent(event);
            window.boardId = data.board.id;
            notificationOverlay.classList.add('d-none');
            notifications.splice(idx, 1);
            updateNotificationUI();
          } catch (e) {
            alert('Chyba při načítání tabule.');
          }
        });
        notificationList.appendChild(item);
      });
    }

    notificationBtn.addEventListener('click', () => {
      notificationOverlay.classList.toggle('d-none');
    });

    notificationClose.addEventListener('click', () => {
      notificationOverlay.classList.add('d-none');
    });

    // Socket.IO listener for board invitations
    if (typeof window.SW_SOCKET !== 'undefined' && window.SW_SOCKET) {
      console.log('Setting up notification listener on socket');
      window.SW_SOCKET.on('notification:board-invite', (data) => {
        console.log('Received notification:', data);
        notifications.push({
          type: 'board-invite',
          boardId: data.boardId,
          boardName: data.boardName,
          message: `${data.invitedByName} vás pozval do tabule "${data.boardName}"`
        });
        updateNotificationUI();
      });
      
      // Listener pro žádosti o přátelství
      window.SW_SOCKET.on('notification:friend-request', (data) => {
        console.log('Received friend request notification:', data);
        notifications.push({
          type: 'friend-request',
          fromUserId: data.fromUserId,
          fromUserName: data.fromUserName,
          fromUserEmail: data.fromUserEmail,
          message: `${data.fromUserName} vám poslal žádost o přátelství`
        });
        updateNotificationUI();
      });
      
      // Listener pro přijetí žádosti o přátelství
      window.SW_SOCKET.on('notification:friend-accepted', (data) => {
        console.log('Received friend accepted notification:', data);
        notifications.push({
          type: 'friend-accepted',
          fromUserId: data.fromUserId,
          fromUserName: data.fromUserName,
          message: `${data.fromUserName} přijal vaši žádost o přátelství`
        });
        updateNotificationUI();
      });
    } else {
      console.warn('SW_SOCKET not available for notifications');
    }

    updateNotificationUI();
  </script>
</body>
</html>
